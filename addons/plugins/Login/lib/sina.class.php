<?php include_once( 'sina/config.php' );include_once( 'sina/saetv2.ex.class.php' );class sina{        var $loginUrl;    private $_sina_akey;    private $_sina_skey;        public function __construct() {        $this->_sina_akey = WB_AKEY;        $this->_sina_skey = WB_SKEY;    }        function getUrl( $call_back = null, $needSkip, $uid, $isPick ) {        if ( empty($this->_sina_akey) || empty($this->_sina_skey) )             return false;        if (is_null($call_back)) {            if ( $isPick ) {                $call_back = U( 'home/Public/PickCallback', array( 'type' => 'sina' ) );            }            else {                if ( $needSkip == 1 ) {                    $call_back = U( 'home/Public/callback', array('skip' => 1, 'newid' => $uid) );                }                else {                    $call_back = U('home/Public/callback');                }            }        }        if (C('TEST_OTHERS_SITE')) {            $call_back = 'http://www.smarterapps.cn/weibo/bind.tst';        }                $_SESSION['WB_CALLBACK_URL'] = $call_back;        $o                           = new SaeTOAuthV2( $this->_sina_akey , $this->_sina_skey  );        $this->loginUrl = $o->getAuthorizeURL( $call_back );        return $this->loginUrl . '&with_offical_account=1';    }        function getJSON($userid,$passwd){        $o      = new WeiboOAuth( $this->_sina_akey , $this->_sina_skey  );        $keys   = $o->getRequestToken();        $return = $o->getAuthorizeJSON( $keys['oauth_token'] ,false , $userid,$passwd);        if($return){            $return       = json_decode($return);            $o            = new WeiboOAuth( $this->_sina_akey , $this->_sina_skey ,$keys['oauth_token'] , $keys['oauth_token_secret']  );            $access_token = $o->getAccessToken(  $return->oauth_verifier ) ;            return $access_token;        }    }        //用户资料    function userInfo(){        $tokeninfo = $_SESSION['sina']['access_token'];                $c = new SaeTClientV2( $this->_sina_akey, $this->_sina_skey, $tokeninfo );        $uid_get = $c->get_uid();                $uid = $uid_get['uid'];        $me = $c->show_user_by_id( $uid);                        $user['id']          = $me['id'];        $user['uname']       = $me['name'];        $user['province']    = $me['province'];        $user['city']        = $me['city'];        $user['location']    = $me['location'];        $user['userface']    = str_replace(  $user['id'].'/50/' , $user['id'].'/180/' ,$me['profile_image_url'] );        $user['sex']         = ($me['gender']=='m') ? 1 : 0;        return $user;    }        private function doClient($opt){        $oauth_token = ( $opt['oauth_token'] )? $opt['oauth_token']:$_SESSION['sina']['access_token']['access_token'];        $oauth_token_secret = ( $opt['oauth_token_secret'] )? $opt['oauth_token_secret']:$_SESSION['sina']['access_token']['oauth_token_secret'];        return new WeiboClient( $this->_sina_akey , $this->_sina_skey ,  $oauth_token, $oauth_token_secret  );    }        //验证用户    function checkUser(){        //$o = new WeiboOAuth( $this->_sina_akey , $this->_sina_skey , $_SESSION['sina']['keys']['oauth_token'] , $_SESSION['sina']['keys']['oauth_token_secret']  );        $o = new SaeTOAuthV2( $this->_sina_akey , $this->_sina_skey );        $keys                 = array();        $keys['code']         = $_REQUEST['code'];        $keys['redirect_uri'] = $_SESSION['WB_CALLBACK_URL'];//      $access_token = $o->getAccessToken(  $_REQUEST['oauth_verifier'] ) ;        $access_token                            = $o->getAccessToken( 'code', $keys ) ;        $_SESSION['sina']['access_token']        = $access_token['access_token'];        $_SESSION['sina']['access_token_secret'] = $access_token['refresh_token'];        $_SESSION['open_platform_type']          = 'sina';    }        //发布一条微博    function update($text,$opt){        $token = $_SESSION['sina']['access_token'];        if (empty($token)) {            $token = $opt['oauth_token'];        }        $c = new SaeTClientV2( $this->_sina_akey , $this->_sina_skey , $token );                return $c->update( $text );                //return $this->doClient($opt)->update($text);    }        //上传一个照片，并发布一条微博    function upload($text,$pic,$opt){        $token = $opt['oauth_token']; //$_SESSION['sina']['access_token']['access_token'];        if (empty($token)) {            $token = $_SESSION['sina']['access_token'];        }                $c = new SaeTClientV2( $this->_sina_akey , $this->_sina_skey , $token );        $data = $pic ? $c->upload( $text, $pic ):$c->update( $text );        $error_code = array('20111','20019');//相同信息        if (isset($data['error_code']) && ! in_array($data['error_code'], $error_code)){            return false;        }        return true;    }        /**     * 获取粉丝列表     */    public function get_fanslist() {        $token    = $_SESSION['sina']['access_token'];        $c        = new SaeTClientV2( $this->_sina_akey , $this->_sina_skey , $token );        $uid_get  = $c->get_uid();        $uid      = $uid_get['uid'];        $fanslist = $c->followers_by_id($uid, 0, 30);        foreach ($fanslist['users']  as $key => $value) {            $users[$key]['id']       = $value['id'];            $users[$key]['uname']    = $value['name'];            $users[$key]['province'] = $value['province'];            $users[$key]['city']     = $value['city'];            $users[$key]['location'] = $value['location'];            $users[$key]['userface'] = str_replace(  $user['id'].'/50/' , $user['id'].'/180/' ,$value['profile_image_url'] );            $users[$key]['sex']      = ($value['gender']=='m')?1:0;        }        return $users;    }        /**     *      * @param int $uid 外站用户ID     * @param string $token 令牌     * @return boolean     */    public function followuser($uid, $token) {        $c    = new SaeTClientV2( $this->_sina_akey , $this->_sina_skey , $token );        $data = $c->follow_by_id($uid);                if ($data === false || $data === null){            return false;        }                if (isset($data['error_code']) && isset($data['error'])){            return false;        }                return true;    }        /**     *     * @param int $uid 外站用户ID     * @param string $token 令牌     * @return boolean     */    public function unfollowuser($uid, $token) {        $c    = new SaeTClientV2( $this->_sina_akey , $this->_sina_skey , $token );        $data = $c->unfollow_by_id($uid);                if ($data === false || $data === null){            return false;        }                if (isset($data['error_code']) && isset($data['error'])){            return false;        }        return true;    }        /**     * 转发至新浪微博     * @param string $id     * @param string $token     * @param array $opt     * @return boolean     */    public function transpond( $id, $opt ) {        $c = new SaeTClientV2( $this->_sina_akey , $this->_sina_skey , $opt['oauth_token'] );        $data = $c->repost( $id, $opt['text'], $opt['is_comment'] );        if ($data === false || $data === null){            return false;        }                if (isset($data['error_code']) && isset($data['error'])){            return false;        }        return true;    }        /**     * 添加微博评论     * @param int $weibo_id     * @param string $comment     * @param string $token     * @param string $ip     * @return boolean|string     */    public function addWeiboComment( $weibo_id, $opt ) {        $c = new SaeTClientV2( WB_AKEY , WB_SKEY , $opt['oauth_token'], null );            $data = $c->send_comment( $weibo_id, $opt['text'], 1 );                if ($data === false || $data === null){            return false;        }            if (isset($data['error_code']) && isset($data['error'])){//          if ( in_array($data['error_code'], array('21315', '21316', '21317')) )//              return '1001';            return false;        }            if ( !$data['id'] )            return false;            return $data;    }        /**     * 回复评论     * @param string $weibo_id 新浪微博ID     * @param string $comments_id 新浪微博评论ID     * @param array $opt     * @return boolean|string     */    public function commentsReply($weibo_id, $comments_id, $opt) {        $c = new SaeTClientV2( WB_AKEY , WB_SKEY , $opt['oauth_token'], null );                $data = $c->reply($weibo_id, $opt['text'], $comments_id);                if ($data === false || $data === null){            return false;        }                if (isset($data['error_code']) && isset($data['error'])){//          if ( in_array($data['error_code'], array('21315', '21316', '21317')) )//              return '1001';            return false;        }                if ( !$data['id'] )            return false;                return $data;    }        /**     * 获取新浪官方表情     * @param mixed string $token     */    public function getEmotions($opt) {        $c = new SaeTClientV2( WB_AKEY , WB_SKEY , $opt['oauth_token'], null );        $data = $c->emotions();        return $data;    }        function test() {        return 'sina';    }}?>